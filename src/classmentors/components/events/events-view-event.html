<md-content flex class="md-padding">
    <h3>
        Created by {{ ctrl.event.owner.displayName }}
        on {{ ctrl.event.createdAt | date}}
    </h3>

    <md-tabs md-dynamic-height="true" md-border-bottom="true">
        <md-tab label="Tasks" ng-disabled="!ctrl.participants">
            <md-content>
                <h1>Tasks</h1>

                <table class="events tasks" ng-if="ctrl.participants">
                    <thead>
                        <tr>
                            <th>
                               Challenge
                            </th>
                            <th ng-if="ctrl.openedTasks() == 0">
                                <em>No challenge</em>
                            </th>
                            <th ng-repeat="task in ctrl.tasks" ng-if="task.openedAt">
                                {{ task.title }}
                            </th>
                        </tr>
                        <tr>
                            <th>
                               Details
                            </th>
                            <td ng-repeat="task in ctrl.tasks" ng-if="task.openedAt">
                                {{ task.description }}
                            </td>
                        </tr>
                        <tr>
                            <th>
                                Help
                            </th>
                            <td ng-repeat="task in ctrl.tasks" ng-if="task.openedAt">
                                <a ng-href="{{task.link}}" ng-if="task.link">More details</a>
                            </td>
                        </tr>
                        <tr>
                            <th>
                                Completed
                            </th>
                            <td ng-repeat="(taskId, task) in ctrl.tasks" ng-if="task.openedAt">
                                {{ctrl.completed(taskId) | number: 0}} %
                            </td>
                        </tr>
                        <tr>
                            <th>
                               Participants
                            </th>
                            <td ng-repeat="task in ctrl.tasks" ng-if="task.openedAt"></td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="(publicId, participant) in ctrl.participants" ng-class="'index-' + $index">
                            <th layout="row" layout-align="start center">
                                <md-button ng-href="#{{ 'profile' | urlFor:{'publicId': participant.$id} }}">
                                    {{ participant.user.displayName }}
                                </md-button>
                                <span ng-if="ctrl.currentUser.publicId == participant.$id">
                                    <md-button class="md-icon-button md-primary" aria-label="Update">
                                        <md-icon md-svg-icon="loop" ng-click="ctrl.update(ctrl.event, ctrl.tasks, ctrl.currentUserSolutions, ctrl.profile)"></md-icon>
                                    </md-button>
                                </span>
                            </th>
                            <td ng-repeat="(taskId, task) in ctrl.tasks" ng-if="task.openedAt">
                                <div ng-if="task.serviceId">
                                    <span ng-if="participant.tasks[taskId].completed">
                                        Completed
                                    </span>
                                    <span ng-if="!participant.tasks[taskId].completed">
                                        <span ng-if="participant.$id == ctrl.currentUser.publicId">
                                            <span ng-if="ctrl.currentUserProgress[taskId].completed">
                                                Completed*
                                            </span>
                                            <span ng-if="!ctrl.currentUserProgress[taskId].completed">
                                                <md-button class="md-raised md-primary" ng-if="task.serviceId" ng-href="{{ctrl.startLink(task)}}" target="_blank">
                                                    Start challenge
                                                </md-button>
                                            </span>
                                        </span>
                                    </span>
                                </div>

                                <div ng-if="task.linkPattern">
                                    <span ng-if="participant.$id == ctrl.currentUser.publicId">
                                        <md-button class="md-raised md-primary" ng-if="task.linkPattern" ng-click="ctrl.promptForLink(ctrl.event.$id, taskId, task, participant, ctrl.currentUserSolutions)">
                                            <span ng-if="participant.tasks[taskId].completed">
                                                Edit Link
                                            </span>
                                            <span ng-if="!participant.tasks[taskId].completed &amp;&amp; ctrl.currentUserProgress[taskId].completed">
                                                Edit Link*
                                            </span>
                                            <span ng-if="!participant.tasks[taskId].completed &amp;&amp; !ctrl.currentUserProgress[taskId].completed">
                                                Submit Link
                                            </span>
                                        </md-button>
                                    </span>
                                    <span ng-if="participant.tasks[taskId].completed &amp;&amp; participant.$id != ctrl.currentUser.publicId">
                                        <span ng-if="ctrl.currentUser.publicId == ctrl.event.owner.publicId">
                                            <a ng-href="{{ctrl.currentUserSolutions[taskId]}}">Solution</a>
                                        </span>
                                        <span ng-if="ctrl.currentUser.publicId != ctrl.event.owner.publicId">
                                            Completed
                                        </span>
                                    </span>
                                </div>
                            </td>
                        </tr>
                        <tr ng-if="ctrl.participants | spfEmpty">
                            <td>No participants</td>
                        </tr>
                    </tbody>
                </table>
            </md-content>
        </md-tab>

        <md-tab label="Ranking">
            <md-content>
                <h1>Ranking</h1>
                
                <table class="events rankink">
                    <thead>
                        <tr ng-class="{'reversed': ctrl.reverseOrder}">
                            <th ng-class="{orderer: ctrl.orderKey == 'user.displayName'}">
                                <md-button ng-click="ctrl.orderBy('user.displayName')">Participants</md-button>
                            </th>
                            <th ng-class="{orderer: ctrl.orderKey == 'total'}">
                                <md-button ng-click="ctrl.orderBy('total')">Total</md-button>
                            </th>
                            <th ng-class="{orderer: ctrl.orderKey == 'codeCombat'}">
                                <md-button ng-click="ctrl.orderBy('codeCombat')">Code Combat Badges</md-button>
                            </th>
                            <th ng-class="{orderer: ctrl.orderKey == 'codeSchool'}">
                                <md-button ng-click="ctrl.orderBy('codeSchool')">Code School Badges</md-button>
                            </th>
                            <th ng-class="{orderer: ctrl.orderKey == 'singPath'}">
                                <md-button ng-click="ctrl.orderBy('singPath')">SingPath Problems</md-button>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th colspan="5" ng-if="(ctrl.ranking|spfEmpty)">
                                No participants
                            </th> 
                        </tr>
                        <tr ng-repeat="(publicId, participant) in (ctrl.ranking | toArray | orderBy:ctrl.orderKey:ctrl.reverseOrder)" ng-class="'index-' + $index">
                            <th>
                                <md-button ng-href="#{{ 'profile' | urlFor:{'publicId': participant.$id} }}">
                                    {{ participant.user.displayName }}
                                </md-button>
                            </th>
                            <td>{{ participant.total || 0}}</td>
                            <td>{{ participant.codeCombat || 0 }}</td>
                            <td>{{ participant.codeSchool || 0 }}</td>
                            <td>{{ participant.singPath || 0 }}</td>
                        </tr>
                    </tbody>
                </table>

            </md-content>
        </md-tab>
    </md-tabs>
</md-content>
